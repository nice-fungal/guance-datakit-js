<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="./static/dataflux-rum.js"></script>
    <script src="./static/dataflux-logs.js"></script>
    <link rel="stylesheet" href="/index.css" />

    <style>
      .open-window {
        background-color: aqua;
        width: 100px;
        height: 100px;
        position: absolute;
        top: 10px;
      }
    </style>

    <script>
      window.onerror = function (message, source, lineno, colno, error) {
        console.log('window.onerror', message, source, lineno, colno, error)
      }
      window.DATAFLUX_RUM &&
        window.DATAFLUX_RUM.init({
          applicationId: 'guance-datakit-js-demo',
          site: 'https://rum-openway.guance.com',
          clientToken: '2OQwyC4AulthZZNx7lwSRLAZpOaqbyC26ATF0pYdC34y7MP31A',
          service: 'browser',
          env: 'production',
          version: '1.0.0',
          sessionSampleRate: 100,
          sessionOnErrorSampleRate: 100,
          traceType: 'w3c_traceparent',
          sessionReplaySampleRate: 100,
          //   sessionReplayOnErrorSampleRate: 100,
          trackInteractions: true,
          //   workerUrl: './worker.js',
          compressIntakeRequests: false,
          allowFallbackToLocalStorage: true,
          usePartitionedCrossSiteSessionCookie: true,
          trackSessionAcrossSubdomains: true,
          telemetryEnabled: true,
          enableLongAnimationFrame: true,
          retryMaxSize: 10,
          //   remoteConfiguration: true,
          //   beforeSend: function (event, context) {
          //     return true // 这里代表需要上报数据
          //   },
          shouldMaskNode: (node, privacyLevel) => {
            if (node.nodeType === Node.TEXT_NODE) {
              // 如果是文本节点，判断内容是否包含数字
              const textContent = node.textContent || ''
              return /\d+/.test(textContent)
            }
            return false
          },
          allowedDDTracingOrigins: [
            'https://console-api.guance.com',
            'http://testing-ft2x-api.dataflux.cn'
          ]
        })
      // window.DATAFLUX_RUM && window.DATAFLUX_RUM._setDebug(true)
      // window.DATAFLUX_RUM && window.DATAFLUX_RUM.startSessionReplayRecording()
      // window.DATAFLUX_RUM.addRumGlobalContext(
      //   'test_resource_url',
      //   'https://www.google-analytics.com/g/collect?v=2&tid=G-1FC3M6HECR&gtm=45je4cc1v9172232212za200&_p=1736141426730&gcd=13l3l3l3l1l1&npa=0&dma=0&tag_exp=101925629~102067555~102067808~102081485~102198178&_fid=e9zpCGGcU4MTsimxF5v1KM&cid=1873983669.1736141427&ul=zh-cn&sr=1920x1080&uaa=arm&uab=64&uafvl=Google%2520Chrome%3B131.0.6778.205%7CChromium%3B131.0.6778.205%7CNot_A%2520Brand%3B24.0.0.0&uamb=0&uam=&uap=macOS&uapv=15.1.1&uaw=0&are=1&frm=0&pscdl=noapi&_s=2&uid=0&sid=1736141426&sct=1&seg=0&dl=https%3A%2F%2Fh5.mate.ai%2FplayGames%3Fgame_id%3D8%26from%3Dhome_upper_right&dt=Mate.ai-Always%20Beside%20You&en=page_view_july&_ee=1&ep.origin=firebase&ep.app_key=25000003&ep.app_version=&ep.channel=&ep.pkg=&ep.system_version=&ep.device_id=&ep.idfa=&ep.imei=&ep.df_id=&ep.gaid=&ep.event_id=8de523e7-3d59-4995-84bf-0f234ff6272b&epn.event_time=1736141429247&ep.event_type=counter&ep.device_model=&ep.imsi=&ep.android_id=&ep.network=&ep.mate_id=&epn.module=3&epn.content_id=-1&ep.from=HOME_UPPER_RIGHT&ep.args=%7B%22from%22%3A%22HOME_UPPER_RIGHT%22%7D&_et=1861&tfd=11340'
      // )
      // window.DATAFLUX_RUM.setGlobalContextProperty('test', '211')
      window.DATAFLUX_LOGS &&
        window.DATAFLUX_LOGS.init({
          site: 'https://rum-openway.guance.com',
          clientToken: '2OQwyC4AulthZZNx7lwSRLAZpOaqbyC26ATF0pYdC34y7MP31A',
          service: 'browser',
          env: 'production',
          version: '1.0.0',
          // trackSessionAcrossSubdomains: true,
          // usePartitionedCrossSiteSessionCookie: true,
          // telemetryEnabled: true,
          // retryMaxSize: 12,
          // storeContextsToLocal: true,
          // forwardConsoleLogs: ['warn', 'info']
        })
      // window.DATAFLUX_LOGS && window.DATAFLUX_LOGS._setDebug(true)
    </script>
  </head>

  <body>
    <div style="background-color: red; width: 100px; height: 100px" id="test">
      Hello Demo
    </div>
    <div id="operation">
      <button delay="testError">test Error</button>
    </div>

    <script>
      function switchColor() {
        var test = document.getElementById('test')
        test.style.backgroundColor = getRandomColor()
      }
      function buttonsClickHandle(event) {
        const target = event.target
        const tagName = target.tagName.toLowerCase()
        if (tagName !== 'button') return
        const delay = target.getAttribute('delay')
        if (delay === 'sendRequest') {
          const request = sendRequest1()
          // setTimeout(() => {
          //   request.abort()
          // }, 10)
        } else if (delay === 'sendPostFetch') {
          sendPostFetch()
        } else if (delay === 'sendPostRequest') {
          sendPostRequest()
        } else if (delay === 'sendFetch') {
          sendFetch()
        } else if (delay === 'timeoutSendFetch') {
          timeoutSendFetch()
        } else if (delay === 'track_action') {
          action()
        } else if (delay === 'displayDate') {
          displayDate()
        } else if (delay === 'testError') {
          //   sdf = xxx
          console.log(tes222t)
          //   throw new Error('Whoops!')
          // try {

          // } catch(error) {

          // }
        } else if (delay === 'append') {
          right += 10
          const div = document.createElement('div')
          div.setAttribute('class', 'open-window')
          div.setAttribute('style', 'right: ' + right + 'px')
          document.body.append(div)
        } else if (delay === 'open') {
          window.open('https://guance.com', '_blank')
        } else if (delay === 'testSourceMap') {
          window.test()
        } else if (delay === 'testLog') {
          window.DATAFLUX_LOGS &&
            window.DATAFLUX_LOGS.logger.info('sendMessage', {
              name: 'sendMessage',
              action: 'sendMessage',
              botId: 'xxxx'
            })
        } else if (delay === 'testAddAction') {
          window.DATAFLUX_RUM.addAction('test action', {
            a: 'a',
            b: 'b',
            c: 'c'
          })
        } else if (delay === 'dataclone') {
          // 构造一个无法克隆的对象
          const uncloneable = {
            name: 'Uncloneable Object',
            handler: function () {
              console.log('I am a function')
            }, // ❌ 函数无法克隆
            id: Symbol('unique') // ❌ Symbol 也不能被克隆
          }

          worker.postMessage(uncloneable) // 会抛 DataCloneError
        } else {
          sleep(Number(delay) - 5)
          switchColor()
        }
      }
      function init() {
        const operation = document.querySelector('#operation')
        operation.addEventListener('click', buttonsClickHandle, false)
        document
          .getElementById('test')
          .addEventListener('click', switchColor, false)
      }
      init()
    </script>
  </body>
</html>
